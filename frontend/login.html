<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í—Ö–æ–¥ –≤ QazStep</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            background: linear-gradient(135deg, var(--color-light), var(--color-bg));
            margin: 0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
    <div class="notification-container" id="notificationContainer"></div>

    <div class="auth-container">
        <div class="auth-card">
            <div style="text-align: center; margin-bottom: 30px;">
                <i class="fa-solid fa-graduation-cap" style="font-size: 3rem; color: var(--color-primary); margin-bottom: 15px;"></i>
                <h1>–í—Ö–æ–¥ –≤ QazStep</h1>
                <p style="color: var(--color-text); margin-top: 10px;">–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –∏–∑—É—á–µ–Ω–∏–µ –∫–∞–∑–∞—Ö—Å–∫–æ–≥–æ —è–∑—ã–∫–∞</p>
            </div>

            <form id="loginForm">
                <div class="form-group">
                    <label for="email">Email</label>
                    <div style="position: relative;">
                        <i class="fa-solid fa-envelope" style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--color-text);"></i>
                        <input type="email" id="email" required style="padding-left: 45px;" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à email">
                    </div>
                </div>
                <div class="form-group">
                    <label for="password">–ü–∞—Ä–æ–ª—å</label>
                    <div style="position: relative;">
                        <i class="fa-solid fa-lock" style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--color-text);"></i>
                        <input type="password" id="password" required style="padding-left: 45px;" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                    </div>
                </div>

                <div style="margin: 25px 0;">
                    <button type="submit" class="btn btn--primary" style="width: 100%; padding: 16px; font-size: 1.1rem;">
                        <i class="fa-solid fa-sign-in-alt"></i>
                        –í–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç
                    </button>
                </div>

                <div style="text-align: center; margin-top: 25px; padding-top: 25px; border-top: 1px solid rgba(121, 135, 148, 0.2);">
                    <p style="color: var(--color-text);">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞?
                        <a href="register.html" style="color: var(--color-primary); font-weight: 600; text-decoration: none;">
                            –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
                        </a>
                    </p>
                    <p style="margin-top: 15px;">
                        <a href="index.html" style="color: var(--color-text); text-decoration: none;">
                            <i class="fa-solid fa-arrow-left"></i> –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é
                        </a>
                    </p>
                </div>
            </form>
        </div>
    </div>

    <script>
    // ====================
    // API –î–õ–Ø –†–ê–ë–û–¢–´ –° –°–ï–†–í–ï–†–û–ú
    // ====================
    const API_URL = 'http://localhost:3000/api';

    class QazStepAPI {
        // üìå –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        static async checkConnection() {
            try {
                const response = await fetch(`${API_URL}/status`);
                return response.ok;
            } catch {
                return false;
            }
        }

        // üìå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
        static async getUsers() {
            try {
                const response = await fetch(`${API_URL}/users`);
                return await response.json();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
                return JSON.parse(localStorage.getItem('qazstep_users') || '[]');
            }
        }

        static async login(credentials) {
            try {
                const response = await fetch(`${API_URL}/users/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(credentials)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error);
                }

                return await response.json();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:', error);
                throw error;
            }
        }

        // üìå –ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π
        static async addRecentAction(action, type = 'system') {
            const actions = JSON.parse(localStorage.getItem('qazstep_recentActions') || '[]');
            const user = JSON.parse(localStorage.getItem('qazstep_session'));

            const newAction = {
                id: Date.now(),
                action: action,
                type: type,
                user: user ? user.name : 'system',
                timestamp: new Date().toISOString(),
                time: new Date().toLocaleTimeString('ru-RU')
            };

            actions.unshift(newAction);
            if (actions.length > 50) {
                actions.pop();
            }

            localStorage.setItem('qazstep_recentActions', JSON.stringify(actions));
            return newAction;
        }
    }

    // ====================
    // –°–ö–†–ò–ü–¢ –î–õ–Ø –°–¢–†–ê–ù–ò–¶–´ –í–•–û–î–ê
    // ====================

    document.addEventListener("DOMContentLoaded", async function() {
        console.log("–°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—Ö–æ–¥–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞");

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω–∞—è —Å–µ—Å—Å–∏—è
        const session = localStorage.getItem('qazstep_session');
        if (session) {
            try {
                const user = JSON.parse(session);
                showNotification(`–í—ã —É–∂–µ –≤–æ—à–ª–∏ –∫–∞–∫ ${user.name}`, 'info');
                setTimeout(() => {
                    window.location.href = user.role === 'admin' ? 'admin-dashboard.html' : 'index.html';
                }, 1000);
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ —Å–µ—Å—Å–∏–∏:", e);
                localStorage.removeItem('qazstep_session');
            }
        }

        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞
        setupLoginForm();

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
        await initDatabase();
    });

    async function initDatabase() {
        console.log("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...");

        try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º
            const isConnected = await QazStepAPI.checkConnection();
            console.log("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º:", isConnected ? "‚úì –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ" : "‚úó –ù–µ—Ç —Å–≤—è–∑–∏");

            if (isConnected) {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞
                const users = await QazStepAPI.getUsers();

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –∫–∞–∫ –∫—ç—à
                localStorage.setItem('qazstep_users', JSON.stringify(users));

                console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Å —Å–µ—Ä–≤–µ—Ä–∞: ${users.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π`);
            } else {
                console.log('–†–∞–±–æ—Ç–∞–µ–º –≤ –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–º —Ä–µ–∂–∏–º–µ (localStorage)');
                initLocalStorage();
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å —Å–µ—Ä–≤–µ—Ä–∞:', error);
            initLocalStorage();
        }
    }

    function initLocalStorage() {
        // –ï—Å–ª–∏ –Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤
        if (!localStorage.getItem('qazstep_users')) {
            console.log("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–∞–∑—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π");
            localStorage.setItem('qazstep_users', JSON.stringify([]));
        }

        // –ï—Å–ª–∏ –Ω–µ—Ç –¥–µ–π—Å—Ç–≤–∏–π - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º
        if (!localStorage.getItem('qazstep_recentActions')) {
            localStorage.setItem('qazstep_recentActions', JSON.stringify([]));
        }
    }

    function setupLoginForm() {
        const form = document.getElementById('loginForm');
        if (!form) return;

        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            const email = this.querySelector('#email').value;
            const password = this.querySelector('#password').value;

            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –≤–æ –≤—Ä–µ–º—è –ø–æ–ø—ã—Ç–∫–∏ –≤—Ö–æ–¥–∞
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> –í—Ö–æ–¥...';
            submitBtn.disabled = true;

            try {
                // –ü—Ä–æ–±—É–µ–º –≤–æ–π—Ç–∏ —á–µ—Ä–µ–∑ API
                const user = await QazStepAPI.login({ email, password });

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–µ—Å—Å–∏—é
                localStorage.setItem('qazstep_session', JSON.stringify(user));

                // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                const users = JSON.parse(localStorage.getItem('qazstep_users') || '[]');
                const userIndex = users.findIndex(u => u.id === user.id);
                if (userIndex !== -1) {
                    users[userIndex] = user;
                } else {
                    users.push(user);
                }
                localStorage.setItem('qazstep_users', JSON.stringify(users));

                // –î–æ–±–∞–≤–ª—è–µ–º –¥–µ–π—Å—Ç–≤–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é
                await QazStepAPI.addRecentAction(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${user.name} –≤–æ—à–µ–ª –≤ —Å–∏—Å—Ç–µ–º—É`, 'user');

                showNotification(`–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${user.name}!`, 'success');

                // –ü–µ—Ä–µ–∞–¥—Ä–µ—Å–∞—Ü–∏—è
                setTimeout(() => {
                    if (user.role === 'admin') {
                        window.location.href = 'admin-dashboard.html';
                    } else {
                        window.location.href = 'index.html';
                    }
                }, 1000);

            } catch (error) {
                // –ï—Å–ª–∏ API –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø—Ä–æ–±—É–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
                console.log('API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ:', error.message);

                const users = JSON.parse(localStorage.getItem('qazstep_users')) || [];
                const user = users.find(u => u.email === email && u.password === password);

                if (user) {
                    localStorage.setItem('qazstep_session', JSON.stringify(user));
                    await QazStepAPI.addRecentAction(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${user.name} –≤–æ—à–µ–ª –≤ —Å–∏—Å—Ç–µ–º—É`, 'user');

                    showNotification(`–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${user.name}!`, 'success');

                    setTimeout(() => {
                        if (user.role === 'admin') {
                            window.location.href = 'admin-dashboard.html';
                        } else {
                            window.location.href = 'index.html';
                        }
                    }, 1000);
                } else {
                    showNotification('–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å', 'error');
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            }
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    function showNotification(message, type = 'info') {
        const container = document.getElementById('notificationContainer');
        if (!container) return;

        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        const oldNotifications = container.querySelectorAll('.notification');
        oldNotifications.forEach(n => n.remove());

        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;

        let iconClass = 'fa-info-circle';
        if (type === 'success') iconClass = 'fa-check-circle';
        if (type === 'error') iconClass = 'fa-exclamation-circle';
        if (type === 'warning') iconClass = 'fa-exclamation-triangle';

        notification.innerHTML = `
            <div class="notification-content">
                <i class="fas ${iconClass}"></i>
                <span>${message}</span>
            </div>
            <button class="notification-close">&times;</button>
        `;

        container.appendChild(notification);

        setTimeout(() => {
            if (notification.parentNode) {
                notification.classList.add('fade-out');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }
        }, 5000);

        notification.querySelector('.notification-close').addEventListener('click', () => {
            notification.classList.add('fade-out');
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 300);
        });
    }
    </script>
</body>
</html>