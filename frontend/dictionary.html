<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–ª–æ–≤–∞—Ä—å –∫–∞–∑–∞—Ö—Å–∫–æ–≥–æ —è–∑—ã–∫–∞ ‚Äî QazStep</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <style>
        .dictionary-page {
            padding: 40px 0;
            min-height: 80vh;
        }

        .page-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .page-header h1 {
            color: var(--color-primary);
            margin-bottom: 10px;
            font-size: 2.5rem;
        }

        .page-header p {
            color: var(--color-text);
            font-size: 1.1rem;
            max-width: 700px;
            margin: 0 auto;
        }

        .dictionary-controls {
            margin: 40px auto;
            max-width: 1000px;
            padding: 0 20px;
        }

        .search-field {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-field input {
            flex: 1;
            padding: 14px 20px;
            border: 2px solid rgba(121, 135, 148, 0.2);
            border-radius: 12px;
            font-size: 16px;
            font-family: inherit;
            transition: all var(--transition-base);
        }

        .search-field input:focus {
            border-color: var(--color-primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(40, 65, 109, 0.1);
        }

        .filter-chips {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .filter-chip {
            padding: 10px 20px;
            background: rgba(40, 65, 109, 0.1);
            border: 2px solid transparent;
            border-radius: 20px;
            color: var(--color-primary);
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-base);
            font-size: 0.95rem;
        }

        .filter-chip:hover {
            background: rgba(40, 65, 109, 0.2);
            transform: translateY(-2px);
        }

        .filter-chip.is-active {
            background: var(--color-primary);
            color: white;
        }

        .dictionary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
            margin: 40px auto;
            max-width: 1000px;
            padding: 0 20px;
        }

        .word-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: var(--shadow-soft);
            transition: all var(--transition-base);
            border: 1px solid rgba(204, 182, 140, 0.2);
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .word-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(40, 65, 109, 0.15);
        }

        .word-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .word-kazakh {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--color-primary);
            margin: 0;
        }

        .word-russian {
            font-size: 1.2rem;
            color: var(--color-text);
            margin-bottom: 10px;
            font-weight: 600;
        }

        .word-transcription {
            color: var(--color-secondary);
            font-size: 0.9rem;
            margin-bottom: 15px;
            font-style: italic;
        }

        .word-category {
            display: inline-block;
            padding: 4px 12px;
            background: rgba(97, 139, 104, 0.1);
            color: var(--color-success);
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .word-example {
            color: var(--color-text);
            font-size: 0.95rem;
            line-height: 1.6;
            margin-bottom: 15px;
            padding: 12px;
            background: rgba(40, 65, 109, 0.03);
            border-radius: 10px;
            border-left: 3px solid var(--color-primary);
        }

        .word-example kaz {
            color: var(--color-primary);
            font-weight: 600;
        }

        .word-actions {
            display: flex;
            gap: 10px;
            margin-top: auto;
            padding-top: 15px;
            border-top: 1px solid rgba(121, 135, 148, 0.1);
        }

        .audio-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(40, 65, 109, 0.1);
            border: none;
            color: var(--color-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-base);
        }

        .audio-btn:hover {
            background: var(--color-primary);
            color: white;
            transform: scale(1.1);
        }

        .favorite-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(204, 182, 140, 0.1);
            border: none;
            color: var(--color-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-base);
        }

        .favorite-btn.active {
            background: var(--color-secondary);
            color: white;
        }

        .favorite-btn:hover {
            transform: scale(1.1);
        }

        .loading {
            text-align: center;
            padding: 100px 20px;
            color: var(--color-text);
        }

        .loading i {
            font-size: 2rem;
            margin-bottom: 20px;
            display: block;
            color: var(--color-primary);
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            display: block;
            color: rgba(121, 135, 148, 0.3);
        }

        .empty-state h3 {
            color: var(--color-primary);
            margin-bottom: 10px;
            font-size: 1.5rem;
        }

        .empty-state p {
            color: var(--color-text);
            margin-bottom: 30px;
            font-size: 1.1rem;
        }

        .alphabet-nav {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 8px;
            margin: 30px 0;
            padding: 20px;
            background: white;
            border-radius: 16px;
            box-shadow: var(--shadow-soft);
        }

        .alphabet-letter {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(40, 65, 109, 0.1);
            color: var(--color-primary);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-base);
            text-decoration: none;
        }

        .alphabet-letter:hover,
        .alphabet-letter.active {
            background: var(--color-primary);
            color: white;
            transform: translateY(-2px);
        }

        .word-difficulty {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 10px;
        }

        .difficulty-a1 { background: rgba(40, 65, 109, 0.1); color: var(--color-primary); }
        .difficulty-a2 { background: rgba(97, 139, 104, 0.1); color: var(--color-success); }
        .difficulty-b1 { background: rgba(204, 182, 140, 0.1); color: var(--color-secondary); }
        .difficulty-b2 { background: rgba(121, 135, 148, 0.1); color: var(--color-text); }

        @media (max-width: 768px) {
            .dictionary-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .word-card {
                padding: 20px;
            }

            .page-header h1 {
                font-size: 2rem;
            }

            .filter-chips {
                justify-content: center;
            }

            .search-field {
                flex-direction: column;
            }

            .alphabet-nav {
                gap: 5px;
            }

            .alphabet-letter {
                width: 35px;
                height: 35px;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 480px) {
            .word-header {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
    <div class="notification-container" id="notificationContainer"></div>

    <header class="site-header">
        <div class="container header__content">
            <a class="logo" href="index.html">QazStep</a>
            <nav class="primary-nav">
                <ul class="nav-list">
                    <li><a class="nav-link" href="lessons.html">–£—Ä–æ–∫–∏</a></li>
                    <li><a class="nav-link" href="theory.html">–¢–µ–æ—Ä–∏—è</a></li>
                    <li><a class="nav-link is-active" href="dictionary.html">–°–ª–æ–≤–∞—Ä—å</a></li>
                    <li><a class="nav-link" href="admin-dashboard.html">–ê–¥–º–∏–Ω</a></li>
                </ul>
            </nav>
            <div class="auth-buttons" id="authButtons">
                <!-- JS –∑–∞–≥—Ä—É–∑–∏—Ç -->
            </div>
            <button class="hamburger">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </header>

    <main class="dictionary-page">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div class="page-header">
            <h1><i class="fa-solid fa-book"></i> –°–ª–æ–≤–∞—Ä—å –∫–∞–∑–∞—Ö—Å–∫–æ–≥–æ —è–∑—ã–∫–∞</h1>
            <p>–ò–∑—É—á–∞–π—Ç–µ —Å–ª–æ–≤–∞ –ø–æ —Ç–µ–º–∞–º –∏ —É—Ä–æ–≤–Ω—è–º —Å–ª–æ–∂–Ω–æ—Å—Ç–∏. –î–æ–±–∞–≤–ª—è–π—Ç–µ —Å–ª–æ–≤–∞ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞.</p>
        </div>

        <!-- –ö–æ–Ω—Ç—Ä–æ–ª—ã -->
        <div class="dictionary-controls">
            <div class="search-field">
                <input type="text" id="dictionarySearch" placeholder="–ü–æ–∏—Å–∫ —Å–ª–æ–≤–∞ –Ω–∞ –∫–∞–∑–∞—Ö—Å–∫–æ–º –∏–ª–∏ —Ä—É—Å—Å–∫–æ–º...">
                <button class="btn btn--primary" onclick="searchWords()">
                    <i class="fa-solid fa-search"></i> –ü–æ–∏—Å–∫
                </button>
                <button class="btn btn--secondary" onclick="showAddWordModal()">
                    <i class="fa-solid fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–≤–æ
                </button>
            </div>

            <!-- –ê–ª—Ñ–∞–≤–∏—Ç -->
            <div class="alphabet-nav" id="alphabetNav">
                <!-- –ê–ª—Ñ–∞–≤–∏—Ç –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
            </div>

            <div class="filter-chips" id="categoryFilters">
                <button class="filter-chip is-active" data-category="all">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</button>
                <button class="filter-chip" data-category="greetings">–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è</button>
                <button class="filter-chip" data-category="family">–°–µ–º—å—è</button>
                <button class="filter-chip" data-category="food">–ï–¥–∞</button>
                <button class="filter-chip" data-category="travel">–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è</button>
                <button class="filter-chip" data-category="verbs">–ì–ª–∞–≥–æ–ª—ã</button>
                <button class="filter-chip" data-category="adjectives">–ü—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω—ã–µ</button>
                <button class="filter-chip" data-category="favorites" id="favoritesFilter">
                    <i class="fa-solid fa-star"></i> –ò–∑–±—Ä–∞–Ω–Ω–æ–µ
                </button>
            </div>
        </div>

        <!-- –°–µ—Ç–∫–∞ —Å–ª–æ–≤ -->
        <div class="dictionary-grid" id="dictionaryGrid">
            <!-- –°–ª–æ–≤–∞ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
            <div class="loading">
                <i class="fa-solid fa-spinner fa-spin"></i>
                <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ª–æ–≤–∞—Ä—è...</p>
            </div>
        </div>

        <!-- –ï—Å–ª–∏ –Ω–µ—Ç —Å–ª–æ–≤ -->
        <div class="empty-state" id="emptyState" style="display: none;">
            <i class="fa-solid fa-book-open"></i>
            <h3>–°–ª–æ–≤–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
            <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é</p>
            <button class="btn btn--primary" onclick="resetFilters()">
                <i class="fa-solid fa-rotate-left"></i> –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
            </button>
        </div>
    </main>

    <footer class="site-footer">
        <div class="container footer__inner">
            <div class="footer__brand">
                <a class="logo" href="index.html">QazStep</a>
                <p>–®–∞–≥ –∑–∞ —à–∞–≥–æ–º –∫ —Å–≤–æ–±–æ–¥–Ω–æ–º—É –≤–ª–∞–¥–µ–Ω–∏—é –∫–∞–∑–∞—Ö—Å–∫–∏–º —è–∑—ã–∫–æ–º.</p>
                <div class="footer__socials">
                    <a href="#"><i class="fa-brands fa-instagram"></i></a>
                    <a href="#"><i class="fa-brands fa-youtube"></i></a>
                    <a href="#"><i class="fa-brands fa-telegram"></i></a>
                </div>
            </div>
            <div class="footer__links">
                <h4>–ù–∞–≤–∏–≥–∞—Ü–∏—è</h4>
                <ul>
                    <li><a href="lessons.html">–£—Ä–æ–∫–∏</a></li>
                    <li><a href="theory.html">–¢–µ–æ—Ä–∏—è</a></li>
                    <li><a href="dictionary.html">–°–ª–æ–≤–∞—Ä—å</a></li>
                    <li><a href="admin-dashboard.html">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</a></li>
                </ul>
            </div>
            <div class="footer__contacts">
                <h4>–ö–æ–Ω—Ç–∞–∫—Ç—ã</h4>
                <ul>
                    <li><i class="fa-solid fa-envelope"></i> <a href="mailto:hello@qazstep.kz">hello@qazstep.kz</a></li>
                    <li><i class="fa-solid fa-location-dot"></i> –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω</li>
                </ul>
            </div>
        </div>
        <div class="footer__bottom">
            <p>¬© 2024 QazStep. –®–∞–≥ –∑–∞ —à–∞–≥–æ–º –∫ –∑–Ω–∞–Ω–∏—è–º.</p>
        </div>
    </footer>

    <script>
    // ====================
    // API –î–õ–Ø –†–ê–ë–û–¢–´ –° –°–ï–†–í–ï–†–û–ú
    // ====================
    const API_URL = 'http://localhost:3000/api';

    class QazStepAPI {
        // üìå –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        static async checkConnection() {
            try {
                const response = await fetch(`${API_URL}/status`);
                return response.ok;
            } catch {
                return false;
            }
        }

        // üìå –°–ª–æ–≤–∞—Ä—å
        static async getDictionary() {
            try {
                const response = await fetch(`${API_URL}/dictionary`);
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ–≤–∞—Ä—è');
                return await response.json();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ–≤–∞—Ä—è:', error);
                return JSON.parse(localStorage.getItem('qazstep_dictionary') || '[]');
            }
        }

        static async saveWord(word) {
            try {
                const method = word.id ? 'PUT' : 'POST';
                const url = word.id ? `${API_URL}/dictionary/${word.id}` : `${API_URL}/dictionary`;

                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(word)
                });

                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–ª–æ–≤–∞');
                return await response.json();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–ª–æ–≤–∞:', error);
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
                const words = JSON.parse(localStorage.getItem('qazstep_dictionary') || '[]');
                if (word.id) {
                    const index = words.findIndex(w => w.id === word.id);
                    if (index !== -1) {
                        words[index] = word;
                    }
                } else {
                    words.push(word);
                }
                localStorage.setItem('qazstep_dictionary', JSON.stringify(words));
                return word;
            }
        }

        static async deleteWord(id) {
            try {
                await fetch(`${API_URL}/dictionary/${id}`, { method: 'DELETE' });
                return true;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–ª–æ–≤–∞:', error);
                // –£–¥–∞–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
                const words = JSON.parse(localStorage.getItem('qazstep_dictionary') || '[]');
                const filtered = words.filter(w => w.id !== id);
                localStorage.setItem('qazstep_dictionary', JSON.stringify(filtered));
                return true;
            }
        }

        // üìå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
        static async getUsers() {
            try {
                const response = await fetch(`${API_URL}/users`);
                return await response.json();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
                return JSON.parse(localStorage.getItem('qazstep_users') || '[]');
            }
        }

        // üìå –ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π
        static async addRecentAction(action, type = 'system') {
            const actions = JSON.parse(localStorage.getItem('qazstep_recentActions') || '[]');
            const user = JSON.parse(localStorage.getItem('qazstep_session'));

            const newAction = {
                id: Date.now(),
                action: action,
                type: type,
                user: user ? user.name : 'system',
                timestamp: new Date().toISOString(),
                time: new Date().toLocaleTimeString('ru-RU')
            };

            actions.unshift(newAction);
            if (actions.length > 50) {
                actions.pop();
            }

            localStorage.setItem('qazstep_recentActions', JSON.stringify(actions));
            return newAction;
        }

        // üìå –ò–∑–±—Ä–∞–Ω–Ω—ã–µ —Å–ª–æ–≤–∞
        static async getUserFavorites() {
            const user = JSON.parse(localStorage.getItem('qazstep_session'));
            if (!user) return [];

            try {
                const response = await fetch(`${API_URL}/users/${user.id}/favorites`);
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ');
                return await response.json();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ:', error);
                return JSON.parse(localStorage.getItem('qazstep_user_favorites') || '[]');
            }
        }

        static async toggleFavorite(wordId) {
            const user = JSON.parse(localStorage.getItem('qazstep_session'));
            if (!user) return { success: false, error: '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è' };

            try {
                const response = await fetch(`${API_URL}/users/${user.id}/favorites/${wordId}`, {
                    method: 'POST'
                });

                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ');
                return await response.json();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ:', error);
                // –†–∞–±–æ—Ç–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
                let userFavorites = JSON.parse(localStorage.getItem('qazstep_user_favorites') || '[]');

                if (userFavorites.includes(wordId)) {
                    userFavorites = userFavorites.filter(id => id !== wordId);
                } else {
                    userFavorites.push(wordId);
                }

                localStorage.setItem('qazstep_user_favorites', JSON.stringify(userFavorites));
                return { success: true, favorites: userFavorites };
            }
        }
    }

    // ====================
    // –û–°–ù–û–í–ù–û–ô –°–ö–†–ò–ü–¢ –î–õ–Ø –°–õ–û–í–ê–†–Ø
    // ====================

    document.addEventListener("DOMContentLoaded", async function() {
        console.log("–°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–ª–æ–≤–∞—Ä—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞");

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        await initDatabase();
        updateAuthUI();
        setupHamburgerMenu();

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ª–æ–≤–∞—Ä—è
        await loadDictionary();
        setupAlphabet();
        setupCategoryFilters();

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–æ–ª—è –ø–æ–∏—Å–∫–∞
        const searchInput = document.getElementById('dictionarySearch');
        if (searchInput) {
            searchInput.addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    searchWords();
                }
            });
        }
    });

    async function initDatabase() {
        console.log("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Å–ª–æ–≤–∞—Ä—è...");

        try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º
            const isConnected = await QazStepAPI.checkConnection();
            console.log("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º:", isConnected ? "‚úì –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ" : "‚úó –ù–µ—Ç —Å–≤—è–∑–∏");

            if (isConnected) {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞
                const [users, dictionary] = await Promise.all([
                    QazStepAPI.getUsers(),
                    QazStepAPI.getDictionary()
                ]);

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –∫–∞–∫ –∫—ç—à
                localStorage.setItem('qazstep_users', JSON.stringify(users));
                localStorage.setItem('qazstep_dictionary', JSON.stringify(dictionary));

                console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Å —Å–µ—Ä–≤–µ—Ä–∞: ${users.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, ${dictionary.length} —Å–ª–æ–≤`);
            } else {
                console.log('–†–∞–±–æ—Ç–∞–µ–º –≤ –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–º —Ä–µ–∂–∏–º–µ (localStorage)');
                initLocalStorage();
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å —Å–µ—Ä–≤–µ—Ä–∞:', error);
            initLocalStorage();
        }
    }

    function initLocalStorage() {
        // –ï—Å–ª–∏ –Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤
        if (!localStorage.getItem('qazstep_users')) {
            console.log("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–∞–∑—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π");
            localStorage.setItem('qazstep_users', JSON.stringify([]));
        }

        // –ï—Å–ª–∏ –Ω–µ—Ç —Å–ª–æ–≤–∞—Ä—è - —Å–æ–∑–¥–∞–µ–º –¥–µ–º–æ —Å–ª–æ–≤–∞
        if (!localStorage.getItem('qazstep_dictionary')) {
            console.log("–°–æ–∑–¥–∞–µ–º –¥–µ–º–æ —Å–ª–æ–≤–∞—Ä—å");
            const words = [
                {
                    id: 1,
                    kazakh: "–°”ô–ª–µ–º",
                    russian: "–ü—Ä–∏–≤–µ—Ç",
                    transcription: "–°—ç–ª—ç–º",
                    category: "greetings",
                    level: "A1",
                    exampleKazakh: "–°”ô–ª–µ–º, “õ–∞–ª–∞–π—Å—ã–∑?",
                    exampleRussian: "–ü—Ä–∏–≤–µ—Ç, –∫–∞–∫ –¥–µ–ª–∞?",
                    createdAt: new Date().toISOString(),
                    audioUrl: null
                },
                {
                    id: 2,
                    kazakh: "–†–∞“õ–º–µ—Ç",
                    russian: "–°–ø–∞—Å–∏–±–æ",
                    transcription: "–†–∞—Ö–º–µ—Ç",
                    category: "greetings",
                    level: "A1",
                    exampleKazakh: "–†–∞“õ–º–µ—Ç —Å—ñ–∑–≥–µ!",
                    exampleRussian: "–°–ø–∞—Å–∏–±–æ –≤–∞–º!",
                    createdAt: new Date().toISOString(),
                    audioUrl: null
                },
                {
                    id: 3,
                    kazakh: "“ö–∞–ª–∞–π—Å—ã–∑",
                    russian: "–ö–∞–∫ –¥–µ–ª–∞?",
                    transcription: "–ö–∞–ª–∞–π—Å—ã–∑",
                    category: "greetings",
                    level: "A1",
                    exampleKazakh: "“ö–∞–ª–∞–π—Å—ã–∑, –∂–∞“õ—Å—ã–º—ã—Å—ã–∑?",
                    exampleRussian: "–ö–∞–∫ –¥–µ–ª–∞, —É –≤–∞—Å –≤—Å—ë —Ö–æ—Ä–æ—à–æ?",
                    createdAt: new Date().toISOString(),
                    audioUrl: null
                },
                {
                    id: 4,
                    kazakh: "–ê–Ω–∞",
                    russian: "–ú–∞–º–∞",
                    transcription: "–ê–Ω–∞",
                    category: "family",
                    level: "A1",
                    exampleKazakh: "–ú–µ–Ω—ñ“£ –∞–Ω–∞–º –º“±“ì–∞–ª—ñ–º.",
                    exampleRussian: "–ú–æ—è –º–∞–º–∞ —É—á–∏—Ç–µ–ª—å.",
                    createdAt: new Date().toISOString(),
                    audioUrl: null
                },
                {
                    id: 5,
                    kazakh: "”ò–∫–µ",
                    russian: "–ü–∞–ø–∞",
                    transcription: "–≠–∫–µ",
                    category: "family",
                    level: "A1",
                    exampleKazakh: "–ú–µ–Ω—ñ“£ ”ô–∫–µ–º –¥”ô—Ä—ñ–≥–µ—Ä.",
                    exampleRussian: "–ú–æ–π –ø–∞–ø–∞ –≤—Ä–∞—á.",
                    createdAt: new Date().toISOString(),
                    audioUrl: null
                }
            ];
            localStorage.setItem('qazstep_dictionary', JSON.stringify(words));
        }

        // –ï—Å–ª–∏ –Ω–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö —Å–ª–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if (!localStorage.getItem('qazstep_user_favorites')) {
            localStorage.setItem('qazstep_user_favorites', JSON.stringify([]));
        }

        // –ï—Å–ª–∏ –Ω–µ—Ç –¥–µ–π—Å—Ç–≤–∏–π - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º
        if (!localStorage.getItem('qazstep_recentActions')) {
            localStorage.setItem('qazstep_recentActions', JSON.stringify([]));
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    function updateAuthUI() {
        const authButtons = document.getElementById('authButtons');
        if (!authButtons) return;

        const session = localStorage.getItem('qazstep_session');
        let user = null;

        if (session) {
            try {
                user = JSON.parse(session);
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ —Å–µ—Å—Å–∏–∏:", e);
            }
        }

        if (user) {
            authButtons.innerHTML = `
                <div class="user-menu">
                    <span class="user-greeting">
                        <i class="fa-solid fa-user"></i>
                        ${user.name}
                    </span>
                    <button onclick="logout()" class="btn btn--small btn--secondary">
                        –í—ã–π—Ç–∏
                    </button>
                </div>
            `;
        } else {
            authButtons.innerHTML = `
                <div class="auth-buttons">
                    <a href="login.html" class="btn btn--secondary btn--small">
                        –í—Ö–æ–¥
                    </a>
                    <a href="register.html" class="btn btn--primary btn--small">
                        –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                    </a>
                </div>
            `;
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –≤—ã—Ö–æ–¥–∞
    async function logout() {
        const session = localStorage.getItem('qazstep_session');
        let user = null;

        if (session) {
            try {
                user = JSON.parse(session);
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ —Å–µ—Å—Å–∏–∏:", e);
            }
        }

        if (user) {
            await QazStepAPI.addRecentAction(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${user.name} –≤—ã—à–µ–ª –∏–∑ —Å–∏—Å—Ç–µ–º—ã`, 'user');
        }
        localStorage.removeItem('qazstep_session');
        showNotification('–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã', 'success');
        setTimeout(() => {
            updateAuthUI();
            window.location.href = 'index.html';
        }, 1000);
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–Ω—é
    function setupHamburgerMenu() {
        const hamburger = document.querySelector('.hamburger');
        const nav = document.querySelector('.primary-nav');

        if (hamburger && nav) {
            hamburger.addEventListener('click', () => {
                nav.classList.toggle('show');
                hamburger.classList.toggle('is-active');
            });

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Å—Å—ã–ª–∫—É
            nav.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', () => {
                    nav.classList.remove('show');
                    hamburger.classList.remove('is-active');
                });
            });
        }
    }

    async function loadDictionary() {
        try {
            const words = await QazStepAPI.getDictionary();
            await displayWords(words);
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ–≤–∞—Ä—è:', error);
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ–≤–∞—Ä—è', 'error');
        }
    }

    async function displayWords(words) {
        const container = document.getElementById('dictionaryGrid');
        const emptyState = document.getElementById('emptyState');

        if (!container) return;

        if (!words || words.length === 0) {
            container.style.display = 'none';
            if (emptyState) emptyState.style.display = 'block';
            return;
        }

        container.style.display = 'grid';
        if (emptyState) emptyState.style.display = 'none';

        // –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
        const activeCategory = document.querySelector('.filter-chip.is-active')?.dataset.category || 'all';

        // –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –±—É–∫–≤—É
        const activeLetter = document.querySelector('.alphabet-letter.active')?.textContent;

        // –§–∏–ª—å—Ç—Ä—É–µ–º —Å–ª–æ–≤–∞
        let filteredWords = words;

        // –§–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        if (activeCategory !== 'all') {
            if (activeCategory === 'favorites') {
                // –ü–æ–ª—É—á–∞–µ–º –∏–∑–±—Ä–∞–Ω–Ω—ã–µ —Å–ª–æ–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const userFavorites = await QazStepAPI.getUserFavorites();
                filteredWords = words.filter(word => userFavorites.includes(word.id));
            } else {
                filteredWords = words.filter(word => word.category === activeCategory);
            }
        }

        // –§–∏–ª—å—Ç—Ä –ø–æ –±—É–∫–≤–µ
        if (activeLetter && activeLetter !== '–í—Å–µ') {
            filteredWords = filteredWords.filter(word =>
                word.kazakh.charAt(0).toUpperCase() === activeLetter
            );
        }

        // –ü–æ–∏—Å–∫
        const searchTerm = document.getElementById('dictionarySearch').value.toLowerCase();
        if (searchTerm) {
            filteredWords = filteredWords.filter(word =>
                word.kazakh.toLowerCase().includes(searchTerm) ||
                word.russian.toLowerCase().includes(searchTerm) ||
                (word.transcription && word.transcription.toLowerCase().includes(searchTerm))
            );
        }

        if (filteredWords.length === 0) {
            container.style.display = 'none';
            if (emptyState) emptyState.style.display = 'block';
            return;
        }

        // –ü–æ–ª—É—á–∞–µ–º –∏–∑–±—Ä–∞–Ω–Ω—ã–µ —Å–ª–æ–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const userFavorites = await QazStepAPI.getUserFavorites();

        container.innerHTML = '';

        filteredWords.forEach(word => {
            const isFavorite = userFavorites.includes(word.id);

            const card = document.createElement('div');
            card.className = 'word-card';
            card.innerHTML = `
                <div class="word-header">
                    <div>
                        <h3 class="word-kazakh">${word.kazakh}</h3>
                        <p class="word-russian">${word.russian}</p>
                        ${word.transcription ? `<p class="word-transcription">[${word.transcription}]</p>` : ''}
                    </div>
                    <span class="word-difficulty difficulty-${word.level.toLowerCase()}">${word.level}</span>
                </div>

                <span class="word-category">${getCategoryName(word.category)}</span>

                ${word.exampleKazakh ? `
                    <div class="word-example">
                        <p><kaz>${word.exampleKazakh}</kaz></p>
                        ${word.exampleRussian ? `
                            <p style="margin-top: 5px; font-size: 0.9em; color: #666;">${word.exampleRussian}</p>
                        ` : ''}
                    </div>
                ` : ''}

                <div class="word-actions">
                    ${word.audioUrl ? `
                        <button class="audio-btn" onclick="playAudio('${word.audioUrl}')">
                            <i class="fa-solid fa-volume-high"></i>
                        </button>
                    ` : `
                        <button class="audio-btn" onclick="speakWord('${word.kazakh}')">
                            <i class="fa-solid fa-volume-high"></i>
                        </button>
                    `}

                    <button class="favorite-btn ${isFavorite ? 'active' : ''}"
                            onclick="toggleFavorite(${word.id}, this)">
                        <i class="fa-solid ${isFavorite ? 'fa-star' : 'fa-star'}"></i>
                    </button>

                    ${isAdmin() ? `
                        <button class="btn btn--small" onclick="editWord(${word.id})" style="margin-left: auto;">
                            <i class="fa-solid fa-edit"></i>
                        </button>
                    ` : ''}
                </div>
            `;
            container.appendChild(card);
        });
    }

    function setupAlphabet() {
        const alphabetNav = document.getElementById('alphabetNav');
        if (!alphabetNav) return;

        // –ö–∞–∑–∞—Ö—Å–∫–∏–π –∞–ª—Ñ–∞–≤–∏—Ç (–∫–∏—Ä–∏–ª–ª–∏—Ü–∞)
        const kazakhAlphabet = ['”ò', '–ë', '–í', '–ì', '“í', '–î', '–ï', '–Å', '–ñ', '–ó', '–ò', '–ô', '–ö', '“ö', '–õ',
                               '–ú', '–ù', '“¢', '–û', '”®', '–ü', '–†', '–°', '–¢', '–£', '“∞', '“Æ', '–§', '–•', '“∫',
                               '–¶', '–ß', '–®', '–©', '–™', '–´', '–Ü', '–¨', '–≠', '–Æ', '–Ø'];

        // –¢–∞–∫–∂–µ –¥–æ–±–∞–≤–ª—è–µ–º —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ä—É—Å—Å–∫–∏–µ –±—É–∫–≤—ã
        const russianLetters = ['–ê', '–°', '–ú', '–ö', '–ñ', '–†', '–¢', '–î', '–ë', '–ù', '–õ', '–ü', '–ó'];

        // –û–±—ä–µ–¥–∏–Ω—è–µ–º –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –±—É–∫–≤—ã
        const allLetters = [...new Set([...kazakhAlphabet, ...russianLetters])].sort();

        let html = '<a href="#" class="alphabet-letter active" data-letter="all">–í—Å–µ</a>';

        allLetters.forEach(letter => {
            html += `<a href="#" class="alphabet-letter" data-letter="${letter}">${letter}</a>`;
        });

        alphabetNav.innerHTML = html;

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤
        alphabetNav.querySelectorAll('.alphabet-letter').forEach(letter => {
            letter.addEventListener('click', function(e) {
                e.preventDefault();

                // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö –±—É–∫–≤
                alphabetNav.querySelectorAll('.alphabet-letter').forEach(l =>
                    l.classList.remove('active')
                );

                // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Ç–µ–∫—É—â–µ–π –±—É–∫–≤–µ
                this.classList.add('active');

                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ª–æ–≤–∞
                loadDictionary();
            });
        });
    }

    function setupCategoryFilters() {
        const filterChips = document.querySelectorAll('.filter-chip');
        filterChips.forEach(chip => {
            chip.addEventListener('click', function() {
                // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö
                filterChips.forEach(c => c.classList.remove('is-active'));
                // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Ç–µ–∫—É—â–µ–º—É
                this.classList.add('is-active');
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ª–æ–≤–∞
                loadDictionary();
            });
        });
    }

    function searchWords() {
        loadDictionary();
    }

    function resetFilters() {
        document.getElementById('dictionarySearch').value = '';

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        const filterChips = document.querySelectorAll('.filter-chip');
        filterChips.forEach(chip => chip.classList.remove('is-active'));
        filterChips[0].classList.add('is-active'); // "–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏"

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∞–ª—Ñ–∞–≤–∏—Ç
        const alphabetNav = document.getElementById('alphabetNav');
        if (alphabetNav) {
            alphabetNav.querySelectorAll('.alphabet-letter').forEach(letter =>
                letter.classList.remove('active')
            );
            alphabetNav.querySelector('.alphabet-letter[data-letter="all"]').classList.add('active');
        }

        loadDictionary();
    }

    function getCategoryName(category) {
        const categories = {
            'greetings': '–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è',
            'family': '–°–µ–º—å—è',
            'food': '–ï–¥–∞',
            'travel': '–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è',
            'verbs': '–ì–ª–∞–≥–æ–ª—ã',
            'adjectives': '–ü—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω—ã–µ',
            'nouns': '–°—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ',
            'numbers': '–ß–∏—Å–ª–∞',
            'time': '–í—Ä–µ–º—è',
            'colors': '–¶–≤–µ—Ç–∞',
            'animals': '–ñ–∏–≤–æ—Ç–Ω—ã–µ',
            'clothes': '–û–¥–µ–∂–¥–∞',
            'house': '–î–æ–º',
            'work': '–†–∞–±–æ—Ç–∞',
            'health': '–ó–¥–æ—Ä–æ–≤—å–µ'
        };
        return categories[category] || category;
    }

    function speakWord(text) {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º Web Speech API –¥–ª—è –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏—è
        if ('speechSynthesis' in window) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'kk-KZ'; // –ö–∞–∑–∞—Ö—Å–∫–∏–π —è–∑—ã–∫
            utterance.rate = 0.8; // –°–∫–æ—Ä–æ—Å—Ç—å —Ä–µ—á–∏

            // –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –∫–∞–∑–∞—Ö—Å–∫–∏–π –≥–æ–ª–æ—Å
            const voices = speechSynthesis.getVoices();
            const kazakhVoice = voices.find(voice =>
                voice.lang === 'kk-KZ' || voice.lang.startsWith('kk')
            );

            if (kazakhVoice) {
                utterance.voice = kazakhVoice;
            }

            speechSynthesis.speak(utterance);
        } else {
            showNotification('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ–∑–≤—É—á–∫—É —Ç–µ–∫—Å—Ç–∞', 'error');
        }
    }

    async function toggleFavorite(wordId, button) {
        const user = JSON.parse(localStorage.getItem('qazstep_session'));

        if (!user) {
            showNotification('–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–ª—è—Ç—å —Å–ª–æ–≤–∞ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ', 'warning');
            return;
        }

        try {
            const result = await QazStepAPI.toggleFavorite(wordId);

            if (result.success) {
                const isFavorite = button.classList.contains('active');

                if (isFavorite) {
                    button.classList.remove('active');
                    showNotification('–°–ª–æ–≤–æ —É–¥–∞–ª–µ–Ω–æ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ', 'success');

                    // –î–æ–±–∞–≤–ª—è–µ–º –¥–µ–π—Å—Ç–≤–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é
                    await QazStepAPI.addRecentAction(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${user.name} —É–¥–∞–ª–∏–ª —Å–ª–æ–≤–æ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ`, 'dictionary');
                } else {
                    button.classList.add('active');
                    showNotification('–°–ª–æ–≤–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ!', 'success');

                    // –î–æ–±–∞–≤–ª—è–µ–º –¥–µ–π—Å—Ç–≤–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é
                    await QazStepAPI.addRecentAction(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${user.name} –¥–æ–±–∞–≤–∏–ª —Å–ª–æ–≤–æ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ`, 'dictionary');
                }
            } else {
                showNotification(result.error || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ', 'error');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ:', error);
            showNotification('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ', 'error');
        }
    }

    function isAdmin() {
        const session = localStorage.getItem('qazstep_session');
        if (!session) return false;

        try {
            const user = JSON.parse(session);
            return user.role === 'admin';
        } catch (e) {
            return false;
        }
    }

    function showAddWordModal() {
        if (!isAdmin()) {
            showNotification('–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å —Å–ª–æ–≤–∞', 'error');
            return;
        }

        const modalHTML = `
            <div class="modal active" id="addWordModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3><i class="fa-solid fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ —Å–ª–æ–≤–æ</h3>
                        <button class="close-modal">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="addWordForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="wordKazakh">–°–ª–æ–≤–æ –Ω–∞ –∫–∞–∑–∞—Ö—Å–∫–æ–º *</label>
                                    <input type="text" id="wordKazakh" required
                                           placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°”ô–ª–µ–º">
                                </div>

                                <div class="form-group">
                                    <label for="wordRussian">–ü–µ—Ä–µ–≤–æ–¥ –Ω–∞ —Ä—É—Å—Å–∫–∏–π *</label>
                                    <input type="text" id="wordRussian" required
                                           placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü—Ä–∏–≤–µ—Ç">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="wordTranscription">–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è</label>
                                    <input type="text" id="wordTranscription"
                                           placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°—ç–ª—ç–º">
                                </div>

                                <div class="form-group">
                                    <label for="wordCategory">–ö–∞—Ç–µ–≥–æ—Ä–∏—è *</label>
                                    <select id="wordCategory" required>
                                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                                        <option value="greetings">–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è</option>
                                        <option value="family">–°–µ–º—å—è</option>
                                        <option value="food">–ï–¥–∞</option>
                                        <option value="travel">–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è</option>
                                        <option value="verbs">–ì–ª–∞–≥–æ–ª—ã</option>
                                        <option value="adjectives">–ü—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω—ã–µ</option>
                                        <option value="nouns">–°—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ</option>
                                        <option value="numbers">–ß–∏—Å–ª–∞</option>
                                        <option value="time">–í—Ä–µ–º—è</option>
                                        <option value="colors">–¶–≤–µ—Ç–∞</option>
                                        <option value="animals">–ñ–∏–≤–æ—Ç–Ω—ã–µ</option>
                                        <option value="clothes">–û–¥–µ–∂–¥–∞</option>
                                        <option value="house">–î–æ–º</option>
                                        <option value="work">–†–∞–±–æ—Ç–∞</option>
                                        <option value="health">–ó–¥–æ—Ä–æ–≤—å–µ</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="wordLevel">–£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ *</label>
                                    <select id="wordLevel" required>
                                        <option value="A1">A1 (–ù–∞—á–∞–ª—å–Ω—ã–π)</option>
                                        <option value="A2">A2 (–≠–ª–µ–º–µ–Ω—Ç–∞—Ä–Ω—ã–π)</option>
                                        <option value="B1">B1 (–°—Ä–µ–¥–Ω–∏–π)</option>
                                        <option value="B2">B2 (–í—ã—à–µ —Å—Ä–µ–¥–Ω–µ–≥–æ)</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="wordExampleKazakh">–ü—Ä–∏–º–µ—Ä –Ω–∞ –∫–∞–∑–∞—Ö—Å–∫–æ–º</label>
                                <textarea id="wordExampleKazakh" rows="2"
                                          placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°”ô–ª–µ–º, “õ–∞–ª–∞–π—Å—ã–∑?"></textarea>
                            </div>

                            <div class="form-group">
                                <label for="wordExampleRussian">–ü–µ—Ä–µ–≤–æ–¥ –ø—Ä–∏–º–µ—Ä–∞</label>
                                <textarea id="wordExampleRussian" rows="2"
                                          placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü—Ä–∏–≤–µ—Ç, –∫–∞–∫ –¥–µ–ª–∞?"></textarea>
                            </div>

                            <div class="modal-footer">
                                <button type="button" class="btn btn--secondary"
                                        onclick="closeModal('addWordModal')">–û—Ç–º–µ–Ω–∞</button>
                                <button type="submit" class="btn btn--primary">
                                    <i class="fa-solid fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–ª–æ–≤–æ
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHTML);

        document.getElementById('addWordForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const newWord = {
                kazakh: document.getElementById('wordKazakh').value.trim(),
                russian: document.getElementById('wordRussian').value.trim(),
                transcription: document.getElementById('wordTranscription').value.trim(),
                category: document.getElementById('wordCategory').value,
                level: document.getElementById('wordLevel').value,
                exampleKazakh: document.getElementById('wordExampleKazakh').value.trim(),
                exampleRussian: document.getElementById('wordExampleRussian').value.trim(),
                audioUrl: null
            };

            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (!newWord.kazakh || !newWord.russian || !newWord.category || !newWord.level) {
                showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'error');
                return;
            }

            try {
                const savedWord = await QazStepAPI.saveWord(newWord);

                const user = JSON.parse(localStorage.getItem('qazstep_session'));
                await QazStepAPI.addRecentAction(`–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä ${user.name} –¥–æ–±–∞–≤–∏–ª —Å–ª–æ–≤–æ: "${newWord.kazakh}"`, 'dictionary');

                showNotification('–°–ª–æ–≤–æ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ!', 'success');
                closeModal('addWordModal');
                await loadDictionary();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–ª–æ–≤–∞:', error);
                showNotification('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–ª–æ–≤–∞', 'error');
            }
        });

        initModalClose('addWordModal');
    }

    async function editWord(wordId) {
        if (!isAdmin()) {
            showNotification('–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–ª–æ–≤–∞', 'error');
            return;
        }

        try {
            const words = await QazStepAPI.getDictionary();
            const word = words.find(w => w.id === wordId);

            if (!word) {
                showNotification('–°–ª–æ–≤–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', 'error');
                return;
            }

            const modalHTML = `
                <div class="modal active" id="editWordModal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3><i class="fa-solid fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–ª–æ–≤–æ</h3>
                            <button class="close-modal">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form id="editWordForm">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="editWordKazakh">–°–ª–æ–≤–æ –Ω–∞ –∫–∞–∑–∞—Ö—Å–∫–æ–º *</label>
                                        <input type="text" id="editWordKazakh" required
                                               value="${word.kazakh}">
                                    </div>

                                    <div class="form-group">
                                        <label for="editWordRussian">–ü–µ—Ä–µ–≤–æ–¥ –Ω–∞ —Ä—É—Å—Å–∫–∏–π *</label>
                                        <input type="text" id="editWordRussian" required
                                               value="${word.russian}">
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="editWordTranscription">–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è</label>
                                        <input type="text" id="editWordTranscription"
                                               value="${word.transcription || ''}">
                                    </div>

                                    <div class="form-group">
                                        <label for="editWordCategory">–ö–∞—Ç–µ–≥–æ—Ä–∏—è *</label>
                                        <select id="editWordCategory" required>
                                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                                            ${generateCategoryOptions(word.category)}
                                        </select>
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="editWordLevel">–£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ *</label>
                                        <select id="editWordLevel" required>
                                            ${generateLevelOptions(word.level)}
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="editWordExampleKazakh">–ü—Ä–∏–º–µ—Ä –Ω–∞ –∫–∞–∑–∞—Ö—Å–∫–æ–º</label>
                                    <textarea id="editWordExampleKazakh" rows="2">${word.exampleKazakh || ''}</textarea>
                                </div>

                                <div class="form-group">
                                    <label for="editWordExampleRussian">–ü–µ—Ä–µ–≤–æ–¥ –ø—Ä–∏–º–µ—Ä–∞</label>
                                    <textarea id="editWordExampleRussian" rows="2">${word.exampleRussian || ''}</textarea>
                                </div>

                                <div class="modal-footer">
                                    <button type="button" class="btn btn--secondary"
                                            onclick="closeModal('editWordModal')">–û—Ç–º–µ–Ω–∞</button>
                                    <button type="submit" class="btn btn--primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                                    <button type="button" class="btn btn--delete"
                                            onclick="deleteWord(${wordId})">–£–¥–∞–ª–∏—Ç—å</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);

            document.getElementById('editWordForm').addEventListener('submit', async function(e) {
                e.preventDefault();

                const updatedWord = {
                    ...word,
                    kazakh: document.getElementById('editWordKazakh').value.trim(),
                    russian: document.getElementById('editWordRussian').value.trim(),
                    transcription: document.getElementById('editWordTranscription').value.trim(),
                    category: document.getElementById('editWordCategory').value,
                    level: document.getElementById('editWordLevel').value,
                    exampleKazakh: document.getElementById('editWordExampleKazakh').value.trim(),
                    exampleRussian: document.getElementById('editWordExampleRussian').value.trim(),
                    updatedAt: new Date().toISOString()
                };

                try {
                    await QazStepAPI.saveWord(updatedWord);

                    const user = JSON.parse(localStorage.getItem('qazstep_session'));
                    await QazStepAPI.addRecentAction(`–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä ${user.name} –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–ª —Å–ª–æ–≤–æ: "${updatedWord.kazakh}"`, 'dictionary');

                    showNotification('–°–ª–æ–≤–æ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!', 'success');
                    closeModal('editWordModal');
                    await loadDictionary();
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ª–æ–≤–∞:', error);
                    showNotification('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ª–æ–≤–∞', 'error');
                }
            });

            initModalClose('editWordModal');
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ–≤–∞:', error);
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ–≤–∞', 'error');
        }
    }

    function generateCategoryOptions(selectedCategory) {
        const categories = {
            'greetings': '–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è',
            'family': '–°–µ–º—å—è',
            'food': '–ï–¥–∞',
            'travel': '–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è',
            'verbs': '–ì–ª–∞–≥–æ–ª—ã',
            'adjectives': '–ü—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω—ã–µ',
            'nouns': '–°—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ',
            'numbers': '–ß–∏—Å–ª–∞',
            'time': '–í—Ä–µ–º—è',
            'colors': '–¶–≤–µ—Ç–∞',
            'animals': '–ñ–∏–≤–æ—Ç–Ω—ã–µ',
            'clothes': '–û–¥–µ–∂–¥–∞',
            'house': '–î–æ–º',
            'work': '–†–∞–±–æ—Ç–∞',
            'health': '–ó–¥–æ—Ä–æ–≤—å–µ'
        };

        let options = '';
        for (const [value, label] of Object.entries(categories)) {
            const selected = value === selectedCategory ? 'selected' : '';
            options += `<option value="${value}" ${selected}>${label}</option>`;
        }
        return options;
    }

    function generateLevelOptions(selectedLevel) {
        const levels = [
            { value: 'A1', label: 'A1 (–ù–∞—á–∞–ª—å–Ω—ã–π)' },
            { value: 'A2', label: 'A2 (–≠–ª–µ–º–µ–Ω—Ç–∞—Ä–Ω—ã–π)' },
            { value: 'B1', label: 'B1 (–°—Ä–µ–¥–Ω–∏–π)' },
            { value: 'B2', label: 'B2 (–í—ã—à–µ —Å—Ä–µ–¥–Ω–µ–≥–æ)' }
        ];

        let options = '';
        levels.forEach(level => {
            const selected = level.value === selectedLevel ? 'selected' : '';
            options += `<option value="${level.value}" ${selected}>${level.label}</option>`;
        });
        return options;
    }

    async function deleteWord(wordId) {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–ª–æ–≤–æ?')) {
            return;
        }

        if (!isAdmin()) {
            showNotification('–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç —É–¥–∞–ª—è—Ç—å —Å–ª–æ–≤–∞', 'error');
            return;
        }

        try {
            await QazStepAPI.deleteWord(wordId);

            const user = JSON.parse(localStorage.getItem('qazstep_session'));
            await QazStepAPI.addRecentAction(`–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä ${user.name} —É–¥–∞–ª–∏–ª —Å–ª–æ–≤–æ –∏–∑ —Å–ª–æ–≤–∞—Ä—è`, 'dictionary');

            showNotification('–°–ª–æ–≤–æ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ!', 'success');
            closeModal('editWordModal');
            await loadDictionary();
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–ª–æ–≤–∞:', error);
            showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–ª–æ–≤–∞', 'error');
        }
    }

    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.remove();
        }
    }

    function initModalClose(modalId) {
        const modal = document.getElementById(modalId);
        if (!modal) return;

        const closeBtn = modal.querySelector('.close-modal');
        if (closeBtn) {
            closeBtn.addEventListener('click', () => {
                closeModal(modalId);
            });
        }

        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeModal(modalId);
            }
        });
    }

    function showNotification(message, type = 'info') {
        const container = document.getElementById('notificationContainer');
        if (!container) return;

        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        const oldNotifications = container.querySelectorAll('.notification');
        oldNotifications.forEach(n => n.remove());

        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;

        let iconClass = 'fa-info-circle';
        if (type === 'success') iconClass = 'fa-check-circle';
        if (type === 'error') iconClass = 'fa-exclamation-circle';
        if (type === 'warning') iconClass = 'fa-exclamation-triangle';

        notification.innerHTML = `
            <div class="notification-content">
                <i class="fas ${iconClass}"></i>
                <span>${message}</span>
            </div>
            <button class="notification-close">&times;</button>
        `;

        container.appendChild(notification);

        setTimeout(() => {
            if (notification.parentNode) {
                notification.classList.add('fade-out');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }
        }, 5000);

        notification.querySelector('.notification-close').addEventListener('click', () => {
            notification.classList.add('fade-out');
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 300);
        });
    }

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    window.searchWords = searchWords;
    window.resetFilters = resetFilters;
    window.showAddWordModal = showAddWordModal;
    window.toggleFavorite = toggleFavorite;
    window.speakWord = speakWord;
    window.editWord = editWord;
    window.deleteWord = deleteWord;
    window.closeModal = closeModal;
    window.logout = logout;
    </script>
</body>
</html>